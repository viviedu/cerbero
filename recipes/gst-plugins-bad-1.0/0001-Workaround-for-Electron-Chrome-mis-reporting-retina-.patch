From aef57bdb7a5fe7e1cf4da742390c242eafe11f6a Mon Sep 17 00:00:00 2001
From: Mark Fernie <39318992+drmarkfernie@users.noreply.github.com>
Date: Thu, 14 Jun 2018 15:57:38 +1000
Subject: [PATCH] Workaround for Electron/Chrome mis-reporting retina
 scalingFactor

---
 sys/applemedia/avfvideosrc.m | 36 +++++++++++++++++++++++++++++++++++-
 1 file changed, 35 insertions(+), 1 deletion(-)

diff --git a/sys/applemedia/avfvideosrc.m b/sys/applemedia/avfvideosrc.m
index 88b64acc5..500e62f7c 100644
--- a/sys/applemedia/avfvideosrc.m
+++ b/sys/applemedia/avfvideosrc.m
@@ -217,6 +217,7 @@ gst_avf_video_source_device_type_get_type (void)
 #if !HAVE_IOS
 - (CGDirectDisplayID)getDisplayIdFromDeviceIndex;
 - (float)getScaleFactorFromDeviceIndex;
+- (float)getElectronScaleFactorFromDeviceIndex;
 #endif
 - (GstCaps *)getDeviceCaps;
 - (BOOL)setDeviceCaps:(GstVideoInfo *)info;
@@ -546,6 +547,7 @@ static AVCaptureVideoOrientation GstAVFVideoSourceOrientation2AVCaptureVideoOrie
   return [displayId unsignedIntegerValue];
 }
 
+
 - (float)getScaleFactorFromDeviceIndex
 {
   NSArray *screens = [NSScreen screens];
@@ -559,6 +561,37 @@ static AVCaptureVideoOrientation GstAVFVideoSourceOrientation2AVCaptureVideoOrie
   }
   return [[screens objectAtIndex:deviceIndex] backingScaleFactor];
 }
+
+- (float)getElectronScaleFactorFromDeviceIndex
+{
+  NSArray *screens = [NSScreen screens];
+  NSScreen *screen;
+  NSDictionary *description;
+
+  if (deviceIndex == DEFAULT_DEVICE_INDEX)
+  {
+    screen = [NSScreen mainScreen];
+  }
+  else
+  {
+    if (deviceIndex >= [screens count]) {
+      GST_ELEMENT_ERROR (element, RESOURCE, NOT_FOUND,
+                        ("Invalid screen capture device index"), (NULL));
+      return 1.0;
+    }
+    else
+    {
+      screen = [screens objectAtIndex:deviceIndex];
+    }
+  }
+  description = [screen deviceDescription];
+  NSSize resolution = [[description objectForKey:@"NSDeviceResolution"] sizeValue];
+  float backingScaleFactor = (int) resolution.width / 72;
+
+  //NSLog(@"Electron backingScaleFactor : %f", backingScaleFactor);
+  return backingScaleFactor;
+}
+
 #endif
 
 
@@ -802,7 +835,8 @@ static AVCaptureVideoOrientation GstAVFVideoSourceOrientation2AVCaptureVideoOrie
   if (captureScreen) {
 #if !HAVE_IOS
     CGRect rect = CGDisplayBounds ([self getDisplayIdFromDeviceIndex]);
-    float scale = [self getScaleFactorFromDeviceIndex];
+    //float scale = [self getScaleFactorFromDeviceIndex];
+    float scale = [self getElectronScaleFactorFromDeviceIndex]; // ALT FUNCTION FOR ELECTRON APP.
     for (NSNumber *pixel_format in pixel_formats) {
       GstVideoFormat gst_format = [self getGstVideoFormat:pixel_format];
       if (gst_format != GST_VIDEO_FORMAT_UNKNOWN)
-- 
2.17.0

